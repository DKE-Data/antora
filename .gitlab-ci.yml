image: node:10.14.2-stretch
stages: [ init, verify, deploy ]
.defs:
# only_code not used when an MR is created, hence the need for except_docs
- &only_code
  only:
    changes:
    - .gitlab-ci.yml
    - package.json
    - yarn.lock
    - '{gulpfile.js,packages,test}/**/*'
- &except_docs
  except:
  - /^docs\/./
- &cache_paths
  paths:
  - .cache/yarn
- &pull_cache
  cache:
    policy: pull
    <<: *cache_paths
- &yarn_install
  before_script:
  - yarn --cache-folder=.cache/yarn --pure-lockfile > /dev/null
yarn:
  stage: init
  <<: *except_docs
  <<: *only_code
  cache:
    <<: *cache_paths
  <<: *yarn_install
  script: $(npm bin)/antora version
lint:
  stage: verify
  <<: *except_docs
  <<: *only_code
  <<: *pull_cache
  <<: *yarn_install
  script: $(npm bin)/gulp lint
test:
  stage: verify
  <<: *except_docs
  <<: *only_code
  <<: *pull_cache
  <<: *yarn_install
  script: $(npm bin)/gulp test
  artifacts:
    paths:
    - coverage/
release:
  stage: deploy
  only:
  - releases@antora/antora
  environment: releases
  script:
  - yarn global add lerna@$(node -p 'require("./lerna.json").lerna') > /dev/null
  - npm -v
  - scripts/release.sh
